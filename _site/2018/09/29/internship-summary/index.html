<DOCTYPE html>
<html>
  <head>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9534180453883710"
     crossorigin="anonymous"></script>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ohcryzf6h1");
</script>
	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4LG9G3BTNP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4LG9G3BTNP');
</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Eigen实习总结</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="致力于算法，数据和工程的全链路打通">
    <link rel="canonical" href="http://localhost:4000/2018/09/29/internship-summary/">
    <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ZHPMATRIX blog posts" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <!-- Personal visit times -->
    <script>
	var _hmt = _hmt || [];
	(function() {
  		var hm = document.createElement("script");
  		hm.src = "//hm.baidu.com/hm.js?39e5930446e371d66d738fef008c3ce2";
  		var s = document.getElementsByTagName("script")[0]; 
  		s.parentNode.insertBefore(hm, s);
	})();
	</script>
 </head>


    <body>
    <header class="site-header">

  <div class="wrap">

    <div style="float:floate; margin-top:10px; margin-right:50px;"></div>
    <a class="site-title" href="/">ZHPMATRIX blog</a>
    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
</a>
      <div class="trigger">
 	<font color="yellow"><a class="page-link" href="http://www.souyisou.online/">搜医搜</a></font>
 	<font color="yellow"><a class="page-link" href="https://aitax.17win.com/#/home?Authorization=Bearer+RKgwsKLnZ3uOoZPjU9nPEPP6H/gjZcVgFlgixoqaWSjeXvjxg9jxTA8yJzNOCd94mm7tSpzOgq0w9Q/3XZuY3MitCACEUV88dDvlWFESem/uZVjdHXvDoxFRxGUJLDByEB1GZSxrWvL9mUxlU5ykT9yDV%2BVNCfQLd6YNf7d%2Bss0=&X-App-Key=cb1e9c178a914a61b4db1bd5735f1036&X-Biz-Code=test&X-User-Id=tester&keyword=%E5%B0%8F%E5%9E%8B%E5%BE%AE%E5%88%A9%E4%BC%81%E4%B8%9A%E6%89%80%E5%BE%97%E7%A8%8E%E4%BC%98%E6%83%A0">AI搜税</a></font>
        
          <font color="yellow"><a class="page-link" href="/about/">about</a></font>
        
          
        
          
        
          <font color="yellow"><a class="page-link" href="/project/">project</a></font>
        
	
      </div>
    </nav>
  </div>
  <!-- Personal visit times -->
  <script>
  var _hmt = _hmt || [];
  (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?39e5930446e371d66d738fef008c3ce2";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
  })();
  </script>
  <style>
	body{background-color:#84bf97}
  </style>
 </header>


    <!--<div class="page-content" style="background-color:#F8F8FF;">-->
    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Eigen实习总结</h1>
    <p class="meta">
      Sep 29, 2018
      
      • 
      <span class="meta-tags">
        
          <span class="tag">生活杂谈</span>
        
      </span>
      
      • <span id="busuanzi_container_page_pv">阅读量：<span id="busuanzi_value_page_pv"></span>次</span>
    </p>
  </header>

  <article class="post-content">
  <p><em><a href="https://www.eigentech.ai/">Eigen</a>是一家AI初创公司，A轮，实习时间共十周。实习很大的一个感受是，公司风格Google Style，成员学历都很不错，浙大，科大为主，实习生来自海外名校的很多，前端组基本都是硕士，算法组我知道的有三个博士，整体上感觉不错。实习的时候，算法这边感觉很像实验室的生活节奏，不过模型上线的时候，还是很忙。但是产品组紧跟业务，加班挺多的。这篇博客是从实习总结中修改而来的，可能有些内网链接失效。</em></p>

<h3 id="零-前言">零. 前言</h3>

<p>这篇实习总结报告将围绕四个部分来完成。第一部分对实习任务进行分析；第二部分讲述了中文语法错误诊断（CGED）的工作；第三部分回顾拼写检查（SpellChecker）的工作；第四部分谈一下本次实习的经验和教训。</p>

<h3 id="一-任务分析">一. 任务分析</h3>

<p>本次实习任务是中文语法检纠错。场景是中文，包含两个子目标检错和纠错，对象是语法。针对这个任务，首先需要明确研究对象，也就是要解决的错误类型，以及错误类型的成因。为此，调研了关于中文语法错误相关的文献近20篇，形成文献合集《中文错别字调研论文合集》，结论是中文语法错误类型众多，成因复杂。
围绕该任务的公开数据集和比赛较少。调研过程中，发现该任务和IJCNLP2017承办的一个比赛Chinese Grammatical Error Diagnosis(CGED)类似，于是决定首先从复现这个任务开始，为实习任务提供一个baseline。</p>

<h3 id="二-cged">二. CGED</h3>

<p>这个比赛已经举办五届，是ICCE, ACL, COLING, IJCNLP的子赛道任务，具体可以查看<a href="http://www.cged.science/">官网</a>说明。比赛针对HSK的数据集，也就是非母语环境，非母语使用者的中文错误标注，进行四类错误类型的检错，具体包括多词，少词，错词，和词序不当。2018年的比赛添加了纠错任务，实习任务开启时，2018年的比赛尚未结束，所以，可以看到的是2017年的一个不错的结果对应的相关论文《Chinese Grammatical Error Diagnosis with Long Short-Term Memory Networks》，作者群来自HIT的刘挺组。该工作将此任务作为序列标注问题来做，模型主要使用BiLSTM，输入特征分为三类，分别是Bigram Embedding，Character Embedding，Pos Embedding，每个时间步有四个输入，当前时刻和前一时刻的Bigram Embedding，当前对应的Character和Pos的Embedding。后续的工作中，文章做了将CRF的输出作为BiLSTM的输入，融合上述三类特征，发现有进一步提升。注意，这里是不同于常见的BiLSTM+CRF的模型组合去做序列标注任务的，CRF担任的是decode的角色，而文章中CRF担任的是一个特征生成的角色。</p>

<p>针对这篇文章，联系了文章一作郑博，现为刘挺组的在读博士生，拿到了源代码。代码后端基于cnn-v1，前端数据预处理部分基于python。在调试运行该源代码后，发现缺点如下：</p>

<ul>
  <li>
    <p>无GPU支持。CGED16+CGED18作为训练集的前提下，50个Epoch平均耗时6h。考虑到后续的数据增强，目前的代码将会遇到训练速度瓶颈</p>
  </li>
  <li>
    <p>cnn-v1是cmu开发的基于C++的小众框架，常见组件和技术文档缺乏，扩展性差。</p>
  </li>
  <li>
    <p>源代码耦合度较高，代码风格较差。比如，在inference模块抽离过程中，遇到了各种由于多个global variable存在导致的问题。</p>
  </li>
</ul>

<p>由于上述问题的存在，决定放弃直接使用源代码，自己基于tensorflow重新实现。这里是源码地址，复现结果在评测指标上基本符合预期。</p>

<p>有了一个baseline，接下来做的工作就是能够提供一个接口或者用于测试的交互界面，也就是需要将模型部署。针对这部分工作，实现两个版本的代码。第一种是前端采用Flask框架，后端自己做字典资源的加载，模型载入，预处理，模型预测和后处理等逻辑；第二种是采用tensorflow-serving完成，这也是公司推荐的方式，前端不变，后端有变。tensorflow-serving的方式是将模型放到一个tensorflow model server上，然后提供一个访问接口给后端来用，方便了session管理，模型迭代等诸多工作，源码地址在这里。
部署完成后，实测结果不够理想。限于比赛官方提供的数据集非常少，首先尝试从数据角度出发，去构造更多的数据。针对比赛提供的四种错误类型，具体的构造规则见周报，增强代码在这里。基于上述增强后的数据，重新train了一个新的模型，从评估指标来看，该模型的预测能力不如不做增强的模型，分析原因可能是在做数据增强的时候，错误类型比较密集，导致模型在获取上下文语义的时候比较困难。于是重新做了增强，保证每个文本只有一个错误类型，基于该数据集的模型并未重新train。</p>

<p>由于我们考虑基于CGED的数据集来做，可能距离实用较远，于是暂时中止CGED的工作，转向错误类型更明确，应用场景更实际的拼写检查工作。从市场上的已有产品调研来看，比如无错字和云查错等，也多是针对这种场景做检查，比如输入法检错等。</p>

<p>实际上围绕CGED也做了一些其他的工作，具体代码详见这个<a href="https://github.com/CGEDJNU">Repo</a>。</p>

<h3 id="三-spellchecker">三. SpellChecker</h3>

<p>拼写检查，从做输入法开始，就有一拨人在做这个事情。在实习开始前，征哥就做了一个初版。初版的数据规模和类型较少，模型使用BiLSTM+Multi Head Self-Attention，试图建立拼音-&gt;字的映射关系，但是模型似乎对获取上下文的能力较弱。后续训练了一个语言模型，但是效果较差，于是目前所有的精力都Focus在非语言模型上，做持续改进。</p>

<p>从建模方式上，我们着重考虑了两种映射方式，拼音-&gt;字和字-&gt;字。其中，拼音分为带音调和不带音调，实验证明，带音调对于同音字检查问题是一个重要特征。</p>

<p>从特征层面上，输入特征可以是单独的不带音调拼音，带音调拼音，字，也可以是他们的组合。</p>

<p>从数据层面上，这个是我们的一个重点关注的方向。截止目前，围绕数据层面，做了三个工作。第一是扩大量。围绕这个问题，我们基于LCSTS，做了数据增强，每句一个同音字错误。效果有提升。第二是考虑句子长短。我们基于全网新闻数据集生成了新版数据。第三个工作构建了更具diversity的数据集，数据来源为LCSTS, News，淘宝，微信，中文对话，电影台词六个数据集。</p>

<p>从模型层面上，我们做了对比实验，比较了Multi Head Self-Attention的提升效果，尝试了BiLSTM加不加Dropout的影响，同时也尝试了基于BiLSTM+CRF，但是汉字字典大小为8000，这样CRF转移概率矩阵的大小就是8000x8000，训练速度非常慢。</p>

<p>上述改进的方向，在我和征哥的近期周报中都可以看到具体的参数设置和评估指标等。</p>

<p>最近了解到NLPCC TASK2 GEC这个比赛也是做中文语法检错，不过语料集和CGED类似，都是非母语使用者所犯的错误，错误分布和拼音输入法的错误分布应该存在不一致问题，这个比赛提供了用NMT的方式去自动检错的思路。同时看到云查错这款产品的一个研究人员在知乎的一个回答，如下：</p>

<p><code class="language-plaintext highlighter-rouge">目前中文文本纠错普遍不太理想。商业版的也就黑马一家，不过比较贵，而且速度慢，对新词处理不理想，尤其是互联网文本的查错比较差。错别字针对应用场景，可以分为：搜索词纠错（这个多半用历史搜索词来校对）、通用文本纠错（一般性的文章）、特定领域纠错（如政府公文、医疗领域）。 考虑计算机文本输入，目前有拼音输入、五笔输入、OCR输入三种主要的方式，需要针对这三种方式去考虑。 目前基于机器统计的办法是主流的。训练阶段，要建立ngram模型和字、词混淆集。建立ngram语言模型，需要考虑ngram的平滑度。字、词混淆集的建立是一个重点，要从字形、字义、音近、音同等几个方面去考虑。 对于要纠错的文本，计算局部位置的ngram概率，找到可能的“嫌疑词”，通过字、词混淆集去构建候选的词，用候选词替换原词，再计算ngram概率，如果显著上升，则是比较可信的候选词。 最后，需要对候选词进一步使用句法依存关系，判断候选词的语义级别的概率，减少误报。 完全基于机器推荐，也不能解决所有问题，还是要积累一些特定规则，对明显是错别字但是难以机器失败的，可以加入规则来解决。 笔者实现了一个错别字算法，云查错，你可以试试：http://www.http://yunchacuo.com
</code></p>

<p>我们希望有个general的模型可以做检错，但是短期来看似乎难度很大。只有RNN+Attention或者RNN+CRF似乎不能够完全解决问题，需要同时配合其他的一些统计或者规则方法，模型和工程的结合更好的去解决问题。回到当前，首先尽可能用上述方法去解决同音字全拼错误的问题；其次，同音字简拼错误；最后形近字纠检错。这样的话，才可能有一个针对输入法错误可用的检查器。</p>

<h3 id="四-经验教训总结">四. 经验教训总结</h3>

<p>在本次实习之前，自己几乎没有接触过NLP的任务，此外也是第一次去使用Tensorflow搭建Pipeline，静态图和动态图的使用体验不是很一样，不过很庆幸，Tensorflow2.0开始默认支持动态图了，同样是第一次使用Tensorflow Serving，了解到Tensorflow生态的部署理念。再者，Eigen提供了一个很好的项目NLP-Onboard，提供了一些推荐论文，同时从组里同事们的周报中也看到一些推荐的阅读论文，自己又从2018年的各个NLP顶会中搜集了一些文章，实习期间大概读了30+篇文章，对NLP领域的前沿有个大致的了解。最重要的是实习期间，从同事们那里学习到了很多。和斌哥，征哥讨论问题的时候，看大家周报的时候，看到俊哥长长的读书笔记后，看到Github学优的代码后，看到兴华的CV后，看到一圣坐在工位的时候（他一直在那里，不是吗？)等等。此外，总是很欢乐的金金同学和前端组的同事们，也总是使得气氛很活跃。</p>

<p>但是，回顾项目实施过程中，也有很多教训需要反思。首先是要重视论文或者比赛SOTA与算法能用之间的距离。从一开始，征哥就强调，我们需要的是能用的，而不是SOTA。其次，要针对业务有合适的评估指标。CGED从比赛角度有自己的评估指标，实际上在做的时候，我自己采用了Confusion Matrix看P, R和F1-score三个指标，这个是更细粒度的指标。但是在SpellChecker中我们则定义了五个有针对性的评估指标，尽可能全面评估模型的效果，实际上定义合适且正确的指标可能是最重要的事情。最后，要贯彻一套代码的原则，整理出适合自己的一个Pipeline。在复现过程中，走了一些弯路，因为对框架的不熟悉，导致自己在实现的时候遇到一些细节上的问题。很多任务具有相似性，一个Pipeline可以用来做很多任务，这个是后续需要注意的地方，提高代码的可复用性。</p>


  </article>

  <!-- mathjax -->
  
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  

  <!-- 不蒜子统计 -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = 'https://arvinx.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">ZHPMATRIX blog</h2>

    <div class="footer-col-1 column">
      <ul>
	 <li><a href="https://mp.weixin.qq.com/s?__biz=MzU2MTY2ODEzNA==&mid=2247484598&idx=1&sn=ffbf5407ffd399a591930023639b2560&chksm=fc740dffcb0384e9f8fd98446fb0279fff5d4660fa78aed349b2ae15b2192b037900f9d3943f&token=1310413677&lang=zh_CN#rd">微信公众号《KBQA沉思录》</a></li>
        <li><a href="mailto:zhpmatrix@gmail.com">Gmail邮箱</a></li> 
        <li><a href="https://weibo.com/u/2879902091">微博</a></li> 
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/zhpmatrix">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">zhpmatrix</span>
          </a>
        </li>
       </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">致力于算法，数据和工程的全链路打通</p>
    </div>

  </div>
  
</footer>


    </body>
</html>
