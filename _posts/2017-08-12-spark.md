---
layout: post
title: "[æ¯”èµ›]PAC-2017æ¯”èµ›å·¥å…·ç¯‡-Spark"
excerpt: "å…¨å›½å¹¶è¡Œåº”ç”¨æŒ‘æˆ˜èµ›ä¹‹äººå·¥æ™ºèƒ½ç»„çš„èµ›é¢˜ï¼šåŸºäºNLPçš„é‡‘èè¥é”€æ´»åŠ¨æƒ…æ„Ÿåˆ†æï¼ŒæŒ‡å®šå…³äºå¼€æºåº“ä¸ºIntelå¼€å‘çš„åŸºäºSparkçš„BigDLï¼Œè¿™ç¯‡æ–‡ç« å›é¡¾äº†æ¯”èµ›ä¸­ä½¿ç”¨Sparkè¿›è¡Œæ•°æ®é¢„å¤„ç†çš„ä»£ç ç»†èŠ‚ã€‚"
date: 2017-08-12 13:50:00
mathjax: true
---

å…¨å›½å¹¶è¡Œåº”ç”¨æŒ‘æˆ˜èµ›(PAC-2017)æŒ‡å®šçš„å®˜æ–¹å¼€æºåº“æ˜¯Intelå¼€å‘çš„åŸºäºSparkçš„å¼€æºæ·±åº¦å­¦ä¹ åº“ï¼Œæ—¨åœ¨å‘æŒ¥CPUé›†ç¾¤è€ŒéGPUé›†ç¾¤çš„è®¡ç®—èƒ½åŠ›ã€‚åœ¨è¿‡å»ä¸¤å¹´(éš¾é“è¿‡å»å¾ˆå¤šå¹´?)ï¼Œæ— è®ºæ˜¯éƒ¨åˆ†ä¸šç•ŒåŒä»è¿˜æ˜¯æŸäº›æ— è‰¯åª’ä½“ä½¿å¾—å¤§æ•°æ®çš„æ¦‚å¿µéåœ°ç”ŸèŠ±ğŸŒ¹ï¼Œå½“ç„¶ï¼Œå¦‚ä»Šçš„AIä¹Ÿè¢«æŸäº›åˆ©ç›Šåœˆå­æå‡ºäº†ä¸åˆ‡å®é™…çš„æœŸæœ›è®¾å®šï¼Œå·²ç»è¢«è‡ªåŠ¨åŒ–æ‰€çš„å®—æˆåº†è€å¸ˆåœ¨CCAI2017ä¸Šéª‚äº†ä¸€é€šã€‚ä¸ç®¡æ€æ ·ï¼Œä»æŠ€æœ¯å±‚é¢æ¥è¯´ï¼Œå¤§æ•°æ®æ˜¯ä¸€ä¸ªæœ‰ä»·å€¼çš„æ¦‚å¿µã€‚åœ¨æ­¤ï¼Œå¤šæ‰¯ä¸€å¥ï¼Œä»äº’è”ç½‘äº§å“å‘å±•è§’åº¦æ¥çœ‹ï¼Œå­¦ç•Œå’Œä¸šç•Œä¼¼ä¹éƒ½å…±åŒåœ¨åšä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯**æ‰“é€šä¿¡æ¯(æ•°æ®)æµ**ã€‚ä»æ—©æœŸçš„é—¨æˆ·ç½‘ç«™å°†ä¿¡æ¯ä¸Šç½‘åˆ°è¿‡å»çš„O2Oçš„å‘å±•èåˆçº¿ä¸Šçº¿ä¸‹æ•°æ®ï¼Œå½“ç„¶è¿™ä¸ªèåˆæ˜¯å‚ç›´é¢†åŸŸçš„èåˆï¼Œå‰ä¸ä¹…å»å‚åŠ åä¸ºçš„ä¸€ä¸ªå±•ï¼Œçœ‹åˆ°äº†æ•°æ®åœ¨å¤šé¢†åŸŸçš„èåˆï¼Œå¦‚ä»Šçš„AIï¼Œæ•°æ®æŒ–æ˜ç­‰ï¼Œåˆ™è®²ç©¶å¯¹æ·±å±‚æ•°æ®çš„æŒ–æ˜ï¼Œèƒ½å¤Ÿå‘ç°æœ‰æ„ä¹‰çš„ä¿¡æ¯ã€‚**ç«™åœ¨ä¸ªäººè§’åº¦ï¼Œçœ‹å¥½ç”±äºå¤šé¢†åŸŸæ•°æ®èåˆäº§ç”Ÿæ–°çš„ä¸šåŠ¡ä»·å€¼ã€‚**æ­¤å¤–ï¼Œç›´æ’­å¹³å°çš„å‘å±•ï¼Œä¹Ÿå°†é€æ¸èµ°å‘å¥åº·æ€ï¼Œè‰¯æ€§å‘å±•çš„é“è·¯ã€‚

æ‰¯æ·¡å®Œæ¯•ï¼Œå›å½’æ­£é¢˜ï¼ŒèŠæŠ€æœ¯ã€‚

Hadoopé€‚åˆç¦»çº¿å¤„ç†ï¼Œæ‰€è°“ç¦»çº¿ï¼Œä¸€ä¸ªæ˜¯å¯ä»¥å¤„ç†æ›´å¤šçš„æ•°æ®ï¼Œå¦ä¸€ä¸ªæ˜¯æ‰¹å¤„ç†ã€‚è€ƒè™‘åˆ°å’ŒHDFSçš„ç»“åˆï¼ŒæŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªæŠ€æœ¯ç‚¹å„¿ï¼Œæ­¤å¤–ï¼Œç”±äºç¦»çº¿å¤„ç†ï¼Œåˆ™åœ¨åº”ç”¨åœºæ™¯ä¸Šé€‚åˆå¯¹æ—¶æ•ˆæ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯ä¸è¦æ±‚ç«‹å³åšå‡ºååº”ã€‚

ä¸Hadoopç›¸å¯¹åº”çš„æ˜¯Sparkçš„ç‰¹ç‚¹ï¼ŒSparkæ˜¯åŸºäºå†…å­˜è®¡ç®—çš„ï¼Œæ‰€è°“å†…å­˜è®¡ç®—ï¼Œæ˜¯åœ¨å¯¹ä¸­é—´æ•°æ®çš„å¤„ç†ä¸Šè¡¨ç°å’ŒHadoopä¸åŒï¼ŒSparkæ›´å¤šçš„å°†ä¸­é—´æ•°æ®è½åœ¨å†…å­˜ä¸­ï¼Œè€ŒHadoopåˆ™å°†ä¸­é—´æ•°æ®è½åœ¨ç¡¬ç›˜ä¸Šã€‚ç”±äºåŸºäºå†…å­˜ï¼Œè‡ªç„¶åœ¨I/Oä¸Šçš„æ¶ˆè€—è¦è¿œä½äºHadoopï¼Œé€‚åˆæ—¶æ•ˆæ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¸€äº›åœ¨çº¿ç³»ç»Ÿã€‚æ­¤å¤–ï¼Œè¿™ç§å­˜å‚¨æ¨¡å‹æ›´åŠ é€‚åˆæœºå™¨å­¦ä¹ çš„è¿­ä»£ä¼˜åŒ–ã€‚å½“ç„¶äº†ï¼ŒSparkå¹¶ä¸å…·å¤‡HDFSçš„å­˜å‚¨èƒ½åŠ›ï¼Œè¦å€ŸåŠ©HDFSç­‰æŒä¹…åŒ–æ•°æ®ã€‚

å…³äºHDFSçš„æŠ½è±¡ï¼ŒMasterèŠ‚ç‚¹ç§°ä¸º**NameNode**, WorkerèŠ‚ç‚¹ç§°ä¸º**DataNode**ã€‚å¯¹äºä¸€ä¸ªé›†ç¾¤ï¼Œè‡³å°‘è¦æœ‰ä¸€ä¸ªMasterèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªNameNodeã€‚ä»å•ä¸ªæœºå™¨æ¥çœ‹ï¼Œæ¯ä¸ªæœºå™¨ä¸Šå¯ä»¥æœ‰å¤šä¸ªDataNodeï¼Œä½†æ˜¯è‡³å°‘åœ¨ä¸€ä¸ªé›†ç¾¤çš„æŸå°æœºå™¨ä¸Šå­˜åœ¨ä¸€ä¸ªNameNodeï¼Œå½“ç„¶äº†ï¼Œè¿™å°æœºå™¨ä¸Šä¹Ÿå¯ä»¥æœ‰DataNodeçš„å­˜åœ¨ã€‚

RDDæ˜¯Sparkä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œæ±Ÿæ¹–ä¸­ç§°å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ï¼Œ**æ˜¯åˆ†å¸ƒå¼å†…å­˜çš„æŠ½è±¡æ¦‚å¿µ**ã€‚

RDDçš„ç‰¹æ€§ä¸»è¦ä½“ç°åœ¨ä¸‰ä¸ªæ–¹é¢(æ•²é»‘æ¿æ³¨æ„)ï¼Œç¬¬ä¸€æ˜¯è¡€ç»Ÿå…³ç³»å›¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒSparkç»´æŠ¤ç€RDDsä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œåˆ›å»ºå…³ç³»ã€‚æ¯”å¦‚è¯´ï¼ŒinputRDDé€šè¿‡filteræ“ä½œåˆ›å»ºerrorsRDDå’ŒwarningsRDD, è€Œè¿™ä¸¤ä¸ªRDDå¯ä»¥é€šè¿‡unionæ“ä½œåˆ›å»ºbadLinesRDD,ä¹Ÿå°±æ˜¯è¯´ï¼ŒbadLinesRDDä¾èµ–äºä¸Šè¿°ä¸¤ä¸ªRDDã€‚è¿™æ ·çš„å¥½å¤„æ˜¾è€Œæ˜“è§ï¼Œä»è¡€ç»Ÿå…³ç³»å›¾ä¸­å¯ä»¥æ¢å¤ä¸¢å¤±æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¡€ç»Ÿå…³ç³»å›¾å…¶å®ç»´æŠ¤äº†ä¸€ä¸ªæ•°æ®æ˜ å°„å…³ç³»ã€‚

ç¬¬äºŒæ˜¯å»¶è¿Ÿè®¡ç®—ã€‚Sparkä¸­é’ˆå¯¹RDDçš„æ“ä½œä¸»è¦æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯Transformationå’ŒActionã€‚Transformationæ“ä½œçš„å…¸å‹APIæœ‰map(), filter(),reduceByKey()ç­‰ï¼Œè€ŒActionæ“ä½œçš„ä»£è¡¨æ€§APIæœ‰count(), collect(), save()ç­‰ï¼Œå¯¹äºäºŒè€…æä¾›çš„APIï¼Œå¯ä»¥å‘ç°äºŒè€…çš„åŒºåˆ«ã€‚**Transformationçš„å«ä¹‰å¦‚åŒå…¶åï¼Œå¼ºè°ƒå¯¹æ•°æ®çš„è½¬æ¢ï¼Œè€ŒActionåˆ™å¼ºè°ƒå¯¹æ•°æ®ç»“æœçš„è·å–**ã€‚**æ‰€è°“å»¶è¿Ÿè®¡ç®—æ˜¯æŒ‡å¯¹RDDçš„çœŸæ­£è®¡ç®—å‘ç”Ÿåœ¨å¯¹è¯¥RDDç¬¬ä¸€æ¬¡ä½¿ç”¨Actionæ“ä½œçš„æ—¶å€™**ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯**åŠ è½½æ•°æ®**ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®åœ¨å¿…è¦çš„æ—¶å€™ï¼Œæ‰ä¼šè¢«åŠ è½½è¿›å»ã€‚ä½†æ˜¯è¦å¯¹åŠ è½½è¿™ä¸ªæ“ä½œæœ¬èº«ï¼ˆæ¯”å¦‚ï¼Œä¸€è¡ŒåŠ è½½æ•°æ®çš„ä»£ç ï¼‰è¿›è¡Œå“åº”, æ˜¯é€šè¿‡Sparkå†…éƒ¨çš„metadataè®°å½•çš„ï¼Œä¹ŸåŒ…æ‹¬å¯¹Transformationæ“ä½œçš„å“åº”ã€‚ç±»æ¯”æ‰¾è€æ¿è®¨è®ºé—®é¢˜çš„æ—¶å€™ï¼Œå…ˆå»å’Œè€æ¿çº¦æ—¶é—´ï¼Œç„¶ååœ¨çº¦å®šæ—¶é—´ç›´æ¥å»æ‰¾è€æ¿ï¼Œè€Œä¸æ˜¯ç›´æ¥å»æ‰¾è€æ¿(å°å¿ƒè¢«æ€¼ï¼Œå“ˆå“ˆ)ã€‚å­°ä¼˜å­°åŠ£ï¼Œæ˜¾ç„¶ï¼ä¼˜ç‚¹æ˜¯å‡å°‘æ•°æ®çš„ä¼ è¾“ï¼Œä¹Ÿå°±æ˜¯çœçš„ä½ ç™½è·‘å¤šæ¬¡ã€‚

ç¬¬ä¸‰æ˜¯ç¼“å­˜ã€‚Sparké»˜è®¤æ¯æ¬¡åœ¨RDDä¸Šè¿›è¡ŒActionæ“ä½œæ—¶ï¼Œé‡æ–°è®¡ç®—RDDï¼Œä¹Ÿå°±æ˜¯è¦é‡æ–°è·‘ä¸€éè¡€ç»Ÿå…³ç³»å›¾ã€‚è¿™ä¸ªæ—¶å€™å¾ˆæ˜¾ç„¶çš„æ–¹æ¡ˆæ˜¯ç¼“å­˜æŠ€æœ¯ï¼ŒRDD.persist()å¯ä»¥å®ç°å¯¹RDDçš„é‡å¤åˆ©ç”¨ï¼Œè€Œunpersist()æ˜¯ä»ç¼“å­˜ä¸­ç§»é™¤ã€‚è‡³äºä¸ºä»€ä¹ˆè¦é»˜è®¤æ¯æ¬¡é‡æ–°è®¡ç®—ï¼Ÿè‡³å°‘è¿™ç§ç®€å•ç²—æš´çš„æ–¹æ³•å¯ä»¥çœå»å¾ˆå¤šé—®é¢˜çš„è€ƒè™‘ï¼Œæ¯”å¦‚å¯èƒ½çš„RDDçš„ä¸€è‡´æ€§é—®é¢˜ç­‰ã€‚

ä¸Šè¿°RDDçš„ä¸‰ä¸ªç‰¹æ€§ä¹Ÿæ˜¯Sparkçš„ç²¾åï¼Œæ¯ä¸ªç‰¹æ€§éƒ½åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†æ›´å¥½çš„å®ç°å†…å­˜è®¡ç®—ã€‚å…³äºå„ç§æ“ä½œçš„APIï¼Œå…·ä½“å¯ä»¥Googleï¼Œæ¯•ç«Ÿæˆ‘ä¹Ÿè®°ä¸ä½(å›§)ã€‚

è‡³æ­¤ï¼Œæˆ˜ç•¥å±‚é¢çš„ä¸œè¥¿å·²ç»è®¨è®ºå®Œæ¯•ï¼Œæ¥ä¸‹æ¥ï¼Œä¼‘æ¯ä¸€ä¸‹ï¼Œå»çœ‹çœ‹æˆ˜æœ¯å±‚é¢çš„ä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯”èµ›ä¸­æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨Sparkå®Œæˆæ—¢å®šç›®æ ‡çš„ã€‚

å‡è®¾å¯¹é“¶è”äº§å“çš„**æ•´ä½“è¯„ä»·**è¿™ä¸ªæ ‡ç­¾è¿›è¡Œä¸‰åˆ†ç±»(å¥½ï¼Œä¸­ï¼Œå·®),å…·ä½“æ•°æ®å’Œæ¯”èµ›è¦æ±‚å¯å‚çœ‹å®˜æ–¹ç½‘ç«™ã€‚åˆ™æˆ‘ä»¬çš„è®­ç»ƒæ•°æ®å¦‚ä¸‹ï¼š

texts = è¯„è®ºæ–‡æœ¬,æ•´ä½“è¯„ä»·

ç¬¬ä¸€æ­¥ç”ŸæˆRDDï¼š

    data_rdd = sc.parallelize(texts)

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSparkContext(sc)ä¼šæ ¹æ®é›†ç¾¤çš„æƒ…å†µè‡ªåŠ¨è®¾å®šsliceçš„æ•°å€¼ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åˆ†æˆå¤šå°‘ä»½äº†ï¼Œå½“ç„¶å¯ä»¥è‡ªå·±è®¾å®šã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨é»˜è®¤ã€‚

ç¬¬äºŒæ­¥ç”Ÿæˆå…³é”®è¯ï¼šç”Ÿæˆå…³é”®è¯çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œå¯¹æ‰€æœ‰è¯„è®ºæ–‡æœ¬è¿›è¡Œåœç”¨è¯è¿‡æ»¤åè¿›è¡Œè¯é¢‘ç»Ÿè®¡ï¼Œç„¶åå»æ‰å‰10ä¸ªé¢‘ç‡æœ€é«˜çš„è¯æ±‡ï¼Œç„¶åæŒ‰ç…§è¯é¢‘é€’å‡çš„é¡ºåºé€‰æ‹©990ä¸ªè¯æ±‡ä½œä¸ºæœ€ç»ˆçš„å…³é”®è¯ã€‚ä¸ºå•¥ï¼Ÿå› ä¸ºè¯é¢‘è¶Šé«˜æ„å‘³ç€åœ¨è¯„è®ºæ–‡æœ¬ä¸­å‡ºç°æ¬¡æ•°è¶Šå¤šï¼Œä¹Ÿå°±æ˜¯ç‰¹å¾äº†ã€‚

    word_to_ic = analyze_texts(data_rdd,stopwords)

å…¶ä¸­ï¼Œstopwordså°±æ˜¯åœç”¨è¯è¡¨ã€‚analyze_textsçš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼š

    def analyze_texts(data_rdd,stopwords):
          def index(w_c_i):
              ((w, c), i) = w_c_i
              return (w, (i + 1, c))
        return data_rdd.flatMap(lambda text_label: text_to_words(text_label[0],stopwords)) \
              .map(lambda word: (word, 1)).reduceByKey(lambda a, b: a + b) \
              .sortBy(lambda w_c: - w_c[1]).zipWithIndex() \
              .map(lambda w_c_i: index(w_c_i)).collect()

    def text_to_words(review_text,stopwords):
         words = list(jieba.cut(review_text.replace('\n','')))
         # Filter stop words
         words = filterCmt(words,stopwords)
         return words

analyze_textsçš„è¿”å›ç»“æœæ˜¯(å…³é”®è¯ï¼Œ(å…³é”®è¯ç´¢å¼•åºå·ï¼Œè¯é¢‘))ï¼Œå…³é”®è¯ç´¢å¼•åºå·æ˜¯æŒ‰ç…§è¯é¢‘é€’å‡ä¾æ¬¡å¢åŠ ã€‚

sortBy(lambda w_c:-w_c[1])è¡¨ç¤ºæŒ‰ç…§è¯é¢‘é€’å‡æ’åºï¼Œå…¶ä¸­w_cçš„ç»“æ„æ˜¯(å…³é”®è¯ï¼Œè¯é¢‘)ï¼Œ'_'çš„ä½œç”¨æ›´åƒæ˜¯å ä½ç¬¦ï¼Œè¿™ç§ç”¨æ³•åœ¨å†…éƒ¨å‡½æ•°indexçš„å®ç°ä¸­åŒæ ·æœ‰ä½“ç°ï¼ˆè¿·ä¹‹å¾®ç¬‘ï¼‰ã€‚å…³äºindexç»™å‡ºä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š

    w_c_i = ( ('hello',234),2) )
    res = index(w_c_i)
    res = ('hello',(3,234))

zipWithIndex()å‡½æ•°å°†RDDä¸­çš„å…ƒç´ å’Œè¿™ä¸ªå…ƒç´ åœ¨RDDä¸­çš„IDï¼ˆç´¢å¼•å·ï¼‰ç»„åˆæˆé”®å€¼å¯¹ã€‚ä¾‹å¦‚ï¼š

    scala> var rdd2 = sc.makeRDD(Seq("A","B","R","D","F"),2)
    scala> rdd2.zipWithIndex().collect
    
    Array[(String, Long)] = Array((A,0), (B,1), (R,2), (D,3), (F,4))

å…¶ä¸­text_to_wordsçš„é€»è¾‘æ˜¯é’ˆå¯¹æ¯æ¡è¯„è®ºï¼Œå…ˆå»æ‰æ‰€æœ‰æ¢è¡Œç¬¦ï¼Œç„¶åä½¿ç”¨åˆ†è¯å·¥å…·jiebaè¿›è¡Œä¸­æ–‡åˆ†è¯ï¼Œç„¶åè¿”å›åˆ†è¯åçš„ä¸€ä¸ªåˆ—è¡¨ã€‚

ç¬¬ä¸‰æ­¥ï¼šå°†å…³é”®è¯åˆ†å‘åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚

    bword_to_ic = sc.broadcast(word_to_ic)

broadcastå³å¹¿æ’­åè®®ã€‚

ç¬¬å››æ­¥ï¼šå°†è¯å‘é‡åˆ†å‘åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚
    
    bfiltered_w2v = sc.broadcast(filtered_w2v)

æ³¨æ„è¿™é‡Œçš„è¯å‘é‡æ˜¯å’Œå…³é”®è¯å¯¹åº”çš„è¯å‘é‡ï¼Œè¯å‘é‡é¢„å…ˆæ˜¯é’ˆå¯¹æ‰€æœ‰è¯„è®ºæ–‡æœ¬è®­ç»ƒå¾—æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶é›†ç¾¤ä¸ŠåŒæ—¶å­˜åœ¨å…³é”®è¯å’Œå…³é”®è¯å¯¹åº”çš„è¯å‘é‡ã€‚

ç¬¬äº”æ­¥ï¼šå°†è®­ç»ƒæ•°æ®è½¬æ¢æˆä¸‹è¿°æ ¼å¼

è¯„è®ºæ–‡æœ¬çš„å…³é”®è¯åˆ—è¡¨,æ•´ä½“è¯„ä»·

    tokens_rdd = data_rdd.map(lambda text_label:([w for w in text_to_words(text_label[0],stopwords)
        if w in bword_to_ic.value], text_label[1]))

ç¬¬å…­æ­¥ï¼šå…³é”®è¯å¡«å……ã€‚ä¸ºå•¥å‘¢ï¼Ÿæœ‰çš„è¯„è®ºæ–‡æœ¬é•¿ï¼Œæœ‰çš„è¯„è®ºæ–‡æœ¬çŸ­ï¼Œè¿™æ ·é€šè¿‡å¡«å……ä¸€äº›æ²¡æœ‰ä¿¡æ¯é‡çš„ç¬¦å·ï¼Œä½¿å¾—æ‰€æœ‰çš„å…³é”®è¯åˆ—è¡¨é•¿åº¦ä¸€è‡´ï¼Œè¾¾åˆ°å¤„ç†ä¸Šçš„æ–¹ä¾¿ï¼Œæ¯”å¦‚è¯´åœ¨ç»™æ¨¡å‹å–‚æ•°æ®çš„æ—¶å€™ã€‚

    padded_tokens_rdd = tokens_rdd.map(lambda tokens_label: (pad(tokens_label[0], "##", sequence_len), 
    tokens_label[1]))

ç¬¬ä¸ƒæ­¥ï¼šå°†è®­ç»ƒæ•°æ®è½¬æ¢æˆä¸‹è¿°æ ¼å¼

è¯„è®ºæ–‡æœ¬çš„å…³é”®è¯å‘é‡åˆ—è¡¨,æ•´ä½“è¯„ä»·

    vector_rdd = padded_tokens_rdd.map(lambda tokens_label:([to_vec(w, bfiltered_w2v.value,embedding_dim)
        for w in tokens_label[0]], tokens_label[1]))

ç¬¬å…«æ­¥ï¼šå°†å…³é”®è¯å‘é‡åˆ—è¡¨è½¬æ¢æˆè¯„è®ºæ–‡æœ¬çŸ©é˜µ

    sample_rdd = vector_rdd.map(
         lambda vectors_label: to_sample(vectors_label[0], vectors_label[1],embedding_dim))

å…¶ä¸­ï¼Œto_sampleçš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼š

    def to_sample(vectors, label, embedding_dim):
      # flatten nested list
      flatten_features = list(itertools.chain(*vectors))
      features = np.array(flatten_features, dtype='float').reshape(
          [sequence_len, embedding_dim])
      return Sample.from_ndarray(features, np.array(label))

è¯­æ³•æ³¨é‡Šï¼šå…¶ä¸­chain()å¯ä»¥æŠŠä¸€ç»„**è¿­ä»£å¯¹è±¡**ä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ›´å¤§çš„è¿­ä»£å™¨ã€‚intä¸æ˜¯å¯è¿­ä»£å¯¹è±¡ã€‚*vectorsè¡¨ç¤ºè®¿é—®ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡é›†åˆã€‚

ç¬¬ä¹æ­¥ï¼šåˆ†å‰²æ•°æ®é›†

    train_rdd, val_rdd = sample_rdd.randomSplit([training_split,1-training_split])

è‡³æ­¤ï¼ŒåŸºäºSparkçš„æ•°æ®å¤„ç†å·¥ä½œç»“æŸã€‚æ¬¢è¿å¼€å¯Sparkä¹‹æ—…ï¼

---

å‚è€ƒ:

1.[ä¸€ä¸ªå®é™…PySparké¡¹ç›®æ€§èƒ½è°ƒä¼˜](http://ju.outofmemory.cn/entry/178124)

2.[PySparkå†…éƒ¨å®ç°](http://blog.csdn.net/lantian0802/article/details/36376873)

è®¨è®ºäº†RDDï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä»¥åŠPySparkä¸­çš„å‡ ä¸ªç»å…¸æ“ä½œã€‚

3.[Pythonå‘½ä»¤è¡Œå‚æ•°å¤„ç†](http://blog.csdn.net/lwnylslwnyls/article/details/8199454)

4.[Sparké»˜è®¤å¹¶è¡Œåº¦](http://www.cnblogs.com/wrencai/p/4231966.html)

5.[sklearnä¸­ä¸¤ç§æ¨¡å‹æŒä¹…åŒ–çš„æ–¹å¼](http://blog.csdn.net/JR_lu/article/details/52932148)

6.[Spark Streaming](http://nbviewer.jupyter.org/github/intel-analytics/BigDL-Tutorials/blob/master/notebooks/spark_basics/structured_streaming.ipynb)

BigDLå®˜æ–¹ç»™å‡ºçš„Spark Streamingä¾‹å­ï¼Œé‡‡ç”¨**netcat**ä½œä¸ºæ•°æ®æµçš„äº§ç”Ÿå·¥å…·ï¼Œåˆ©ç”¨**streaming**æ¥æ”¶æ•°æ®æµå¹¶è¿›è¡Œè¯é¢‘ç»Ÿè®¡ã€‚